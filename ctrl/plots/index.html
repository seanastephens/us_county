<!DOCTYPE html>
<html>
<head>
<title>Final Project</title>

<meta charset="utf-8">

<link rel="stylesheet" type="text/css" href="index.css">
<script src="underscore.js"></script>
<script src="d3.v3.min.js"></script>
<script src="map.js"></script>
<script src="http://d3js.org/topojson.v1.min.js"></script>
<script src="http://d3js.org/queue.v1.min.js"></script>
<style>
</style>
</head>

<body>
<svg id="main" width="800" height="800"></svg>
<svg id="plot"  width="600" height="800"></svg>
<script>

var svg = d3.select("#main");
var width = svg.attr("width"), height = svg.attr("height");
svg = svg.append("g");

// Load reference data
var topo, codes, stateMap;
queue()
  .defer(d3.json, "us.json")
  .defer(d3.json, "fixed_ugc.json")
  .defer(d3.json, 'statecodes.json')
  .await(function(errors, _topo, _codes, _stateMap) {
    if(errors) console.log(errors);
    topo = _topo;
    codes = _codes;
    stateMap = _stateMap;
    console.log('reference data loaded');
  });

function colorMap(svg, data) {
 var keys = d3.keys(data);
 var values = d3.values(data).map(function(d){ return Number(d); });
 
 var max = d3.max(values);
 var waterScale = d3.scale.linear().domain([0, max]).range(["white", "blue"]);
 svg.selectAll('.county').style('fill', function(d) {
   return waterScale(data[codes[d.id].key]);
 });
}

// Load data
queue().defer(d3.json, 'birthList.json').await(function(error, fileList) {
  if(error) { console.log(error); }

  function deferAll(files, callback) {
    var q = queue();
    for(var i = 0; i < files.length; i++) {
      q.defer(d3.json, files[i]);
    }
    q.awaitAll(callback);
  }

  deferAll(fileList.countyFiles, processCountyFiles);
  deferAll(fileList.mapFiles, function(errors, datas) {
    if(errors) { console.log(errors); }
    var data = datas[0];
    buildMap(svg, topo);
    colorMap(svg, data);
  });
});

function processCountyFiles(errors, datas) {
  if(errors) { console.log(errors); }
  
  var v = Object.keys(datas[0]);

  var data = [];
  for(var i = v.length - 1; i >= 0; i--) {
    var o = [];
    var index = v[i];
    for(var j = datas.length - 1; j >= 0; j--) {
      o.push([1990 + j, Number(datas[j][index])]);
    }
    data.push({name: v[i], data:o});
  }

  lineplot(data, '#plot'); 
}

// Finally...
function lineplot(data, svgId) {
  var svg = d3.select(svgId);

  var w = svg.attr("width"), h = svg.attr("height");
  var topMargin = 50, botMargin = 40, rightMargin = 0; leftMargin = 50;
  var wStart = leftMargin, wEnd = w - rightMargin;
  var hEnd = topMargin, hStart = h - botMargin;

  svg.selectAll('path').remove();
  svg.selectAll('.axis').remove();
  var xMin = d3.min(data, function(d) { 
    return d3.min(d.data, function(e) { return e[0] });
  });
  var xMax = d3.max(data, function(d) { 
    return d3.max(d.data, function(e) { return e[0] });
  });
  var xExtent = [xMin, xMax];

  var yMin = d3.min(data, function(d) { 
    return d3.min(d.data, function(e) { return e[1] });
  });
  var yMax = 2 * d3.max(data, function(d) { 
    return d3.mean(d.data, function(e) { return e[1] });
  });
  var yExtent = [yMin, yMax];

  var xscale = d3.scale.linear().domain(xExtent).range([wStart,wEnd]);
  var yscale = d3.scale.linear().domain(yExtent).range([hStart,hEnd]);
  var xaxis = d3.svg.axis().scale(xscale).orient("bottom");
  var yaxis = d3.svg.axis().scale(yscale).orient("left");

  var map = d3.select('#main');
  var brush = d3.svg.brush()
                .x(xscale)
                .y(yscale)
                .on("brush", brushmove)
                .on("brushend", brushend);
  function brushmove(p) {
    var e = brush.extent();
    var selected = {}
    svg.selectAll(".dataPath").classed('unselectedByLine', function(d) {
        var sel = _.filter(d.data, function(x) {  
          return x[0] > e[0][0] && (x[0] < e[0][0] + 1 || x[0] < e[1][0]);
        });
        var sel2 = _.filter(sel, function(x) {  
          return x[1] > e[0][1] && x[1] < e[1][1]; 
        });
        if(sel2.length == sel.length) {
          selected[d.name] = 1;
          return false;
        } else {
          return true;
        }
    });
    map.selectAll('.county').classed('unselectedByLine', function(d) {
      return !selected[codes[d.id].key];
    });
  }
  function brushend() {
    if (brush.empty()) {
      d3.selectAll(".dataPath").classed('unselectedByLine', false);
      map.selectAll(".county").classed('unselectedByLine', false);
    }
  }
  svg = svg.append("g").call(brush);

  var line = d3.svg.line()
      .x(function(d) { return xscale(d[0]) })
      .y(function(d) { return yscale(d[1]) });

  var lines = svg.selectAll("path").data(data).enter().append("path")
                 .classed("dataPath", true)
                 .attr("d", function(d) { return line(d.data); })

  svg.append("g")
      .attr("class", "axis")
      .attr("transform", "translate(0, " + String(hStart + 10) + ")")
      .call(xaxis);
  svg.append("g")
      .attr("class", "axis")
      .attr("transform", "translate(" + String(wStart - 10) + ", 0)")
      .call(yaxis);
}

</script>
</body>
</html>
